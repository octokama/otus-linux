# otus-linux-les-6  
## grub  

### Домашнее задание

    Работа с загрузчиком
    Цель: Зайти в систему без пароля рута - базовая задача сисадмина ( ну и одно из заданий на любой линуксовой сертификации). Так же нужно уметь управлять поведением загрузчика. Это и будем учиться делать в ДЗ
    1. Попасть в систему без пароля несколькими способами
    2. Установить систему с LVM, после чего переименовать VG
    3. Добавить модуль в initrd

    4(*). Сконфигурировать систему без отдельного раздела с /boot, а только с LVM
    Репозиторий с пропатченым grub: https://yum.rumyantsev.com/centos/7/x86_64/
    PV необходимо инициализировать с параметром --bootloaderareasize 1m
    Критерии оценки: Описать действия, описать разницу между методами получения шелла в процессе загрузки.
    Где получится - используем script, где не получается - словами или копипастой описываем действия.

1. Попасть в систему без пароля.  
1.1. первы способ  
Необходимо зайти в загрузчик до старта системы (перед загрузкой нужно нажать клашиву `e`)  
В строке ```linux16``` нужно убрать все ```console```(```console=tty0 console=ttyS0,115200n8```) и добавить ```rd.break```  и ```enforcing=0``` для загрузки SELinux=Permissive
Затем нажать ```Ctrl+X``` для загрузки системы в аварийном режиме  

Для перемонтирования корня на чтение и запись ввести команды  
```
mount -o remount,rw /sysroot
chroot /sysroot
```
Для смены пароля нужно выполнить команду ```passwd``` или ```passwd root```  
При включенном и активном SELinux необходимо созадть файл в корне, чтобы сделать relabel файлов в системе при помощи ```touch /.autorelabel```  
Далее мы можем зайти под root с новым паролем, после чего необходимо сделать ```fixfiles -f relabel``` для того, чтобы selinux перечитал файлы системы, и при помощи команды ```setenforce 1``` включить SELinux (или в ```/etc/selinux/config``` указать ```SELINUX=Enforcing```)  
  
1.2. второй способ  
Необходимо зайти в загрузчик до старта системы (перед загрузкой нужно нажать клашиву `e`)  
В строке ```linux16``` нужно убрать все ```console```(```console=tty0 console=ttyS0,115200n8```) и добавить ```init=/bin/sh```  
Затем нажать ```Ctrl+X``` для загрузки системы  
Далее необхлодимо перемонтировать корень ```mount -o remount,rw /```  
Смена пароля ```passwd```  
В ```/etc/selinux/config```  необходимо прописать ```SELINUX=Permissive```  
После захода в систему по новому паролю нужно ввести ```fixfilex -f relabel```  
  
  
2. Установить систему с LVM, после чего переименовать VG.  
Для просмотра Volume Group ```vgs```  
Для смены названия VG ```vgrename current_name new_name```  
Проверка ```ls -l /dev/mapper```  
Затем необходимо сменить старое название на новое в  ```/etc/fstab``` для правильной загрузки  
В ```/etc/default/grub``` нужно заменить старое название на новое в строке ```GRUB_CMDLINE_LINUX``` в значениях ```rd.lvm.lv```  
В ```/boot/grub2/grub.cfg``` нужно заменить  название на новое в строке ```linux16```  
Для пересоздания initrd image ```mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)```  
Теперь система будет загружаться с новым названием VG  
  

3. Добавить модуль в initrd.  
Для добавления модуля необходимо создать папку ```mkdir /usr/lib/dracut/modules.d/01usermodule```  с двумя скриптами [module-setup.sh] и [usermodule.sh]  
Скрипты должны быть исполняемыми  ```chmod +x```  
Затем необходимо выполнить ```dracut -f -v```  
После перезагрузки увидим вывод dracut модуля






[module-setup.sh]:https://github.com/octokama/otus-linux/blob/main/6-grub/module-setup.sh
[usermodule.sh]:https://github.com/octokama/otus-linux/blob/main/6-grub/usermodule.sh